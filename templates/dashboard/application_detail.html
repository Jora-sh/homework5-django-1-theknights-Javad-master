{% extends 'base.html' %}
{% load static %}

{% block title %}Application Details | Job Portal{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="row mb-4">
    <div class="col-md-8">
      <h1 class="mb-0">Application Details</h1>
      <p class="text-muted">
        Application for {{ application.job.title }} at {{ application.job.company }}
      </p>
    </div>
    <div class="col-md-4 text-end">
      {% if user.is_seeker %}
        <a href="{% url 'dashboard:applications' %}" class="btn btn-outline-primary">
          <i class="bi bi-arrow-left me-1"></i>Back to Applications
        </a>
      {% elif user.is_employer %}
        <a href="{% url 'dashboard:posted_jobs' %}" class="btn btn-outline-primary">
          <i class="bi bi-arrow-left me-1"></i>Back to Jobs
        </a>
      {% endif %}
    </div>
  </div>

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}

  <div class="row">
    <div class="col-md-8">
      <!-- Job Information -->
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white py-3">
          <h5 class="card-title mb-0">Job Information</h5>
        </div>
        <div class="card-body">
          <h4 class="mb-1">{{ application.job.title }}</h4>
          <h6 class="text-muted mb-3">{{ application.job.company }} â€¢ {{ application.job.location }}</h6>
          
          <div class="mb-3">
            <span class="badge bg-info text-dark me-2">{{ application.job.get_job_type_display }}</span>
            <span class="badge bg-warning text-dark">{{ application.job.get_salary_display }}</span>
          </div>
          
          <div class="mb-4">
            <h6 class="fw-bold">Job Description</h6>
            <p>{{ application.job.description|linebreaks }}</p>
          </div>
          
          <div class="mb-0">
            <h6 class="fw-bold">Requirements</h6>
            <p class="mb-0">{{ application.job.requirements|linebreaks }}</p>
          </div>
        </div>
        <div class="card-footer bg-white py-3">
          <a href="{% url 'jobs:job_detail' application.job.id %}" class="btn btn-sm btn-outline-primary">
            <i class="bi bi-box-arrow-up-right me-1"></i>View Full Job
          </a>
        </div>
      </div>

      <!-- Cover Letter -->
      {% if application.cover_letter %}
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white py-3">
          <h5 class="card-title mb-0">Cover Letter</h5>
        </div>
        <div class="card-body">
          <p class="mb-0">{{ application.cover_letter|linebreaks }}</p>
        </div>
      </div>
      {% endif %}
      
      <!-- Resume Preview -->
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white py-3">
          <h5 class="card-title mb-0">Resume Preview</h5>
        </div>
        <div class="card-body p-0">
          {% with resume_url=application.resume.url %}
            {% if resume_url|slice:"-4:" == ".pdf" %}
              <div class="text-center p-4">
                <div class="mb-3">
                  <i class="bi bi-file-earmark-pdf fs-1 text-danger"></i>
                </div>
                <h5>Resume Preview</h5>
                <p class="mb-3">Click the button below to preview the resume.</p>
                <button class="btn btn-primary" onclick="loadResumePreview('{{ resume_url }}')">
                  <i class="bi bi-eye me-1"></i>Preview Resume
                </button>
              </div>
              <div id="resumePreview" class="ratio ratio-16x9" style="height: 600px; display: none;">
                <iframe id="resumeFrame" width="100%" height="600px" frameborder="0"></iframe>
              </div>
            {% else %}
              <div class="text-center p-4">
                <div class="mb-3">
                  <i class="bi bi-file-earmark-text fs-1 text-muted"></i>
                </div>
                <h5>Preview Unavailable</h5>
                <p class="mb-3">This resume format cannot be previewed inline.</p>
                <a href="{{ resume_url }}" target="_blank" class="btn btn-primary">
                  <i class="bi bi-download me-1"></i>Download Resume
                </a>
              </div>
            {% endif %}
          {% endwith %}
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <!-- Application Status -->
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white py-3">
          <h5 class="card-title mb-0">Application Status</h5>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span class="text-muted">Status:</span>
              {% if application.status == 'pending' %}
                <span class="badge bg-warning text-dark">Pending</span>
              {% elif application.status == 'reviewing' %}
                <span class="badge bg-info">Reviewing</span>
              {% elif application.status == 'shortlisted' %}
                <span class="badge bg-primary">Shortlisted</span>
              {% elif application.status == 'rejected' %}
                <span class="badge bg-danger">Rejected</span>
              {% elif application.status == 'accepted' %}
                <span class="badge bg-success">Accepted</span>
              {% endif %}
            </div>
            <div class="d-flex justify-content-between mb-2">
              <span class="text-muted">Applied on:</span>
              <span>{{ application.applied_at|date:"F j, Y" }}</span>
            </div>
            <div class="d-flex justify-content-between mb-0">
              <span class="text-muted">Last updated:</span>
              <span>{{ application.updated_at|date:"F j, Y" }}</span>
            </div>
          </div>

          <!-- Update Status Form (Employer Only) -->
          {% if user.is_employer %}
          <hr>
          <h6 class="mb-3">Update Application Status</h6>
          <form method="post" id="statusForm">
            {% csrf_token %}
            <select name="status" class="form-select mb-3">
              <option value="pending" {% if application.status == 'pending' %}selected{% endif %}>Pending</option>
              <option value="reviewing" {% if application.status == 'reviewing' %}selected{% endif %}>Reviewing</option>
              <option value="shortlisted" {% if application.status == 'shortlisted' %}selected{% endif %}>Shortlisted</option>
              <option value="rejected" {% if application.status == 'rejected' %}selected{% endif %}>Rejected</option>
              <option value="accepted" {% if application.status == 'accepted' %}selected{% endif %}>Accepted</option>
            </select>
            <div class="d-grid">
              <button type="submit" class="btn btn-primary">Update Status</button>
            </div>
          </form>
          {% endif %}
        </div>
      </div>

      <!-- Resume Download -->
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white py-3">
          <h5 class="card-title mb-0">Resume</h5>
        </div>
        <div class="card-body">
          <div class="d-flex align-items-center mb-3">
            <i class="bi bi-file-earmark-pdf fs-4 me-3 text-danger"></i>
            <span>{{ application.resume.name|truncatechars:20 }}</span>
          </div>
          <div class="d-grid gap-2">
            <button onclick="loadResumePreview('{% url 'dashboard:serve_resume' application.id %}')" class="btn btn-primary">
              <i class="bi bi-eye me-1"></i>View Resume
            </button>
            <a href="{{ application.resume.url }}" download class="btn btn-outline-primary">
              <i class="bi bi-download me-1"></i>Download
            </a>
          </div>
        </div>
      </div>

      <!-- Applicant Information (for Employers) -->
      {% if user.is_employer %}
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white py-3">
          <h5 class="card-title mb-0">Applicant Information</h5>
        </div>
        <div class="card-body">
          <h6 class="fw-bold mb-3">{{ application.user.get_full_name }}</h6>
          <div class="d-flex mb-2">
            <i class="bi bi-envelope me-2"></i>
            <span>{{ application.user.email }}</span>
          </div>
          {% if application.user.phone %}
          <div class="d-flex mb-0">
            <i class="bi bi-telephone me-2"></i>
            <span>{{ application.user.phone }}</span>
          </div>
          {% endif %}
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

{% block extra_js %}
<script>
// Status update form handling
document.getElementById('statusForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const form = this;
    const formData = new FormData(form);
    
    fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update the status badge
            const statusBadge = document.querySelector('.badge');
            statusBadge.className = 'badge ' + data.badge_class;
            statusBadge.textContent = data.status_display;
            
            // Show success message
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show';
            alertDiv.innerHTML = `
                ${data.message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.row'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
});

// Resume preview handling
function loadResumePreview(url) {
    const previewDiv = document.getElementById('resumePreview');
    const frame = document.getElementById('resumeFrame');
    
    // Set the PDF URL directly in the iframe
    frame.src = url;
    previewDiv.style.display = 'block';
    previewDiv.scrollIntoView({ behavior: 'smooth' });
}
</script>
{% endblock %}
{% endblock %} 